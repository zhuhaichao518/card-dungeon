<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>⚔️ Card Dungeon</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="menu-body">

  <!-- 背景粒子 / 装饰 -->
  <div class="menu-bg">
    <div class="bg-glow bg-glow-1"></div>
    <div class="bg-glow bg-glow-2"></div>
  </div>

  <!-- ══ 主菜单面板 ══ -->
  <div id="menu-main" class="menu-screen active">
    <div class="game-logo">
      <div class="logo-icon">⚔️</div>
      <h1 class="game-title">CARD DUNGEON</h1>
      <p class="game-subtitle">魔塔 × 卡牌 × 肉鸽</p>
    </div>

    <nav class="menu-nav">
      <button class="menu-btn primary" onclick="newGame()">▶ 新游戏</button>
      <button class="menu-btn" onclick="showScreen('load')">📁 读取存档</button>
      <button class="menu-btn" onclick="showScreen('howto')">❓ 游戏说明</button>
    </nav>

    <div class="menu-footer">
      素材来源：<a href="https://github.com/ckcz123/mota-js" target="_blank">mota-js</a>
    </div>
  </div>

  <!-- ══ 读档面板 ══ -->
  <div id="menu-load" class="menu-screen">
    <h2 class="panel-title">📁 读取存档</h2>
    <div class="save-slots" id="load-slots">
      <!-- JS动态生成 -->
    </div>
    <button class="menu-btn back-btn" onclick="showScreen('main')">◀ 返回</button>
  </div>

  <!-- ══ 游戏说明面板 ══ -->
  <div id="menu-howto" class="menu-screen">
    <h2 class="panel-title">❓ 游戏说明</h2>
    <div class="howto-content">
      <section>
        <h3>🗺️ 探索</h3>
        <p>用 <kbd>WASD</kbd> 或方向键移动，也可点击相邻格子。</p>
        <p>收集 <span style="color:#ffd700">🔑黄钥匙</span>/<span style="color:#4fc3f7">🔵蓝钥匙</span> 开对应颜色的门。</p>
        <p>踩到 <span style="color:#ff7043">⚠刺陷阱</span> 会损失 10 HP。</p>
        <p>拾取 <span style="color:#e53935">+血瓶</span> 恢复 30 HP。</p>
      </section>
      <section>
        <h3>⚔️ 战斗</h3>
        <p>走到怪物旁会自动触发卡牌战斗。</p>
        <p>每回合获得 <span style="color:#00bcd4">3 点能量</span>，抽 5 张手牌。</p>
        <p>点击卡牌打出，<kbd>结束回合</kbd> 后轮到怪物行动。</p>
        <p>怪物头上会预告下一步行动——提前做好防御！</p>
      </section>
      <section>
        <h3>🃏 牌组</h3>
        <p>初始 10 张牌：打击×3、防御×3、速击、重击、招架、包扎。</p>
        <p>击败怪物后随机获得 1 张新卡，永久加入牌组。</p>
      </section>
      <section>
        <h3>💾 存档</h3>
        <p>游戏中按 <kbd>Esc</kbd> 或点击 ⏸ 打开暂停菜单存档。</p>
        <p>最多 3 个存档槽，随时覆盖保存。</p>
      </section>
    </div>
    <button class="menu-btn back-btn" onclick="showScreen('main')">◀ 返回</button>
  </div>

  <script>
    const SAVE_KEY_PREFIX = 'card_dungeon_save_slot_';

    // 读取所有存档
    function getAllSaves() {
      return [0, 1, 2].map(i => {
        try {
          const raw = localStorage.getItem(SAVE_KEY_PREFIX + i);
          return raw ? JSON.parse(raw) : null;
        } catch { return null; }
      });
    }

    // 切换面板
    function showScreen(name) {
      document.querySelectorAll('.menu-screen').forEach(el => el.classList.remove('active'));
      document.getElementById('menu-' + name).classList.add('active');
      if (name === 'load') renderLoadSlots();
    }

    // 渲染存档槽位
    function renderLoadSlots() {
      const saves = getAllSaves();
      const container = document.getElementById('load-slots');
      container.innerHTML = saves.map((save, i) => `
        <div class="save-slot ${save ? 'has-data' : 'empty'}" onclick="${save ? `loadSlot(${i})` : ''}">
          <div class="slot-header">
            <span class="slot-num">存档 ${i + 1}</span>
            ${save ? `<button class="slot-del" onclick="event.stopPropagation();deleteSlot(${i})">🗑</button>` : ''}
          </div>
          ${save
            ? `<div class="slot-detail">
                <span>⚔️ 第 ${save.floor} 层</span>
                <span>❤️ ${save.player.hp}/${save.player.maxHp}</span>
                <span>🃏 ${save.allCards ? save.allCards.length : '?'} 张牌</span>
               </div>
               <div class="slot-time">${save.savedAt}</div>`
            : '<div class="slot-empty">— 空存档 —</div>'
          }
        </div>
      `).join('');
    }

    // 新游戏
    function newGame() {
      window.location.href = 'game.html';
    }

    // 读取存档跳转
    function loadSlot(slot) {
      sessionStorage.setItem('load_slot', slot);
      window.location.href = 'game.html';
    }

    // 删除存档
    function deleteSlot(slot) {
      if (!confirm(`确定删除存档 ${slot + 1}？`)) return;
      localStorage.removeItem(SAVE_KEY_PREFIX + slot);
      renderLoadSlots();
    }
  </script>
</body>
</html>
